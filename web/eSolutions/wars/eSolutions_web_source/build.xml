<?xml version="1.0" encoding="UTF-8"?>
<project name="eSolutions_web_source" default="build" basedir=".">
    <description>eSolutions_web_source buildfile</description>

    <property environment="env" />
    <property file="buildProps/build.properties" />

    <condition property="is_windows">
        <os family="windows" />
    </condition>
    <condition property="is_unix">
        <os family="unix" />
    </condition>

    <target name="setWindows" if="is_windows">
        <property name="antContribPath" value="C:/xampp/ant/lib/ant-contrib.jar" />
        <property name="tomcat.install.root" value="C:/xampp/tomcat" />
    </target>

    <target name="setUnix" if="is_unix">
        <property name="antContribPath" value="/opt/Apache/ant/current/lib/ant-contrib.jar" />
        <property name="tomcat.install.root" value="/opt/Apache/tomcat/current" />
    </target>

    <taskdef resource="net/sf/antcontrib/antlib.xml">
        <classpath>
            <pathelement location="${antContribPath}" />
        </classpath>
    </taskdef>

    <property name="target.platform" value="${platform}" />

    <condition property="isWebSphere">
        <equals arg1="${target.platform}" arg2="websphere" caseSensitive="false" />
    </condition>
    <condition property="isTomcat">
        <equals arg1="${target.platform}" arg2="tomcat" caseSensitive="false" />
    </condition>
    <condition property="isWebLogic">
        <equals arg1="${target.platform}" arg2="weblogic" caseSensitive="false" />
    </condition>
    <condition property="isGeronimo">
        <equals arg1="${target.platform}" arg2="geronimo" caseSensitive="false" />
    </condition>

    <target name="buildTomcat" if="isTomcat">
        <property name="tomcat.temp.directory" value="${tomcat.install.root}/temp" />
        <property name="tomcat.work.directory" value="${tomcat.install.root}/work" />
        <property name="contextFile" value="${basedir}/target/${projectName}-${projectVersion}/META-INF/context.xml" />

        <copy file="${basedir}/src/main/tomcat/context.xml" tofile="${contextFile}" />

        <replace file="${contextFile}" token="@document.base" value="${documentBase}" />
        <replace file="${contextFile}" token="@cookie.domain.name" value="${cookieDomain}" />
        <replace file="${contextFile}" token="@tomcat.work.dir" value="${tomcat.work.directory}/${projectName}-${projectVersion}/${projectName}-${projectVersion}" />
        <replace file="${contextFile}" token="@database.user.name" value="${dsUser}" />
        <replace file="${contextFile}" token="@database.user.password" value="${dsPass}" />
        <replace file="${contextFile}" token="@database.host.name" value="${dsHost}" />
        <replace file="${contextFile}" token="@amq.host.name" value="${amqHostName}" />
        <replace file="${contextFile}" token="@amq.host.port" value="${amqHostPort}" />
        <replace file="${contextFile}" token="@allowedAddresses" value="${allowedAddresses}" />
        <replace file="${contextFile}" token="@deniedAddresses" value="${deniedAddresses}" />
        <replace file="${contextFile}" token="@allowedHosts" value="${allowedHosts}" />
        <replace file="${contextFile}" token="@deniedHosts" value="${deniedHosts}" />
        <replace file="${contextFile}" token="@sysLogDirectory" value="${sysLogDirectory}" />

        <chmod file="${contextFile}" perm="640" />
    </target>

    <target name="buildWebLogic" if="isWebLogic">
        <copy file="${weblogic}/weblogic.xml" tofile="${basedir}/target/${projectName}-${projectVersion}/WEB-INF/weblogic.xml" />
    </target>

    <target name="buildWebSphere" if="isWebSphere">
        <copy file="${websphere}/ibm-web-bnd.xmi" tofile="${basedir}/target/${projectName}-${projectVersion}/WEB-INF/ibm-web-bnd.xmi" />
        <copy file="${websphere}/ibm-web-ext.xmi" tofile="${basedir}/target/${projectName}-${projectVersion}/WEB-INF/ibm-web-ext.xmi" />

        <replace file="${basedir}/target/${projectName}-${projectVersion}/WEB-INF/ibm-web-bnd.xmi" token="@vhost.name" value="${vhostName}" />
        <replace file="${basedir}/target/${projectName}-${projectVersion}/WEB-INF/ibm-web-ext.xmi" token="@vhost.name" value="${vhostName}" />
    </target>

    <target name="build" depends="setWindows, setUnix, buildTomcat, buildWebLogic, buildWebSphere">
        <tstamp>
            <format property="TODAY" pattern="yyyy-MM-dd HH:mm:ss" />
        </tstamp>

        <exec executable="git" outputproperty="git.revision" failifexecutionfails="false" errorproperty="">
            <arg value="describe"/>
            <arg value="--tags"/>
            <arg value="--always"/>
            <arg value="HEAD"/>
        </exec>

        <touch file="${buildArea}/${projectName}-${projectVersion}.version" />

        <echo message="${projectName} commit version ${git.revision} built ${TODAY}" output="${buildArea}/${projectName}-${projectVersion}.version" append="false" />
    </target>
</project>
