<?xml version="1.0" encoding="UTF-8"?>
<project name="eSolutions_web_source" default="build" basedir=".">
    <description>eSolutions_web_source buildfile</description>

    <property environment="env" />
    <property file="build/build.properties" />
    <propertyfile file="build/build.properties">
        <entry key="major.num" type="int" operation="+" value="1" pattern="0" />
        <entry key="minor.num" type="int" operation="+" value="1" pattern="0" />
        <entry key="build.num" type="int" operation="+" value="1" pattern="00" />
        <entry key="rev.num" type="int" operation="+" value="1" pattern="00" />
    </propertyfile>

    <taskdef resource="net/sf/antcontrib/antlib.xml">
        <classpath>
            <pathelement location="/opt/Apache/ant/current/lib/ant-contrib.jar" />
        </classpath>
    </taskdef>

    <property name="target.platform" value="${platform}" />
    <property name="vhost.name" value="${vhostName}" />

    <condition property="isWebSphere">
        <equals arg1="${target.platform}" arg2="websphere" caseSensitive="false" />
    </condition>
    <condition property="isTomcat">
        <equals arg1="${target.platform}" arg2="tomcat" caseSensitive="false" />
    </condition>
    <condition property="isWebLogic">
        <equals arg1="${target.platform}" arg2="weblogic" caseSensitive="false" />
    </condition>

    <target name="buildTomcat" if="isTomcat">
        <property name="tomcat.install.root" value="/opt/Apache/tomcat" />
        <property name="tomcat.server.root" value="${tomcat.install.root}/servers/esolutions" />
        <property name="tomcat.installedApps.root" value="/appvol/ATS70/esolutions" />
        <property name="tomcat.tmp.directory" value="${tomcat.install.root}/temp" />
        <property name="tomcat.work.directory" value="${tomcat.install.root}/work" />

        <copy file="${basedir}/src/main/tomcat/${WebProjectName}.xml" tofile="${basedir}/target/${WebProjectName}-${ProjectVersion}/META-INF/context.xml" />

        <replace file="${basedir}/target/${WebProjectName}-${ProjectVersion}/META-INF/context.xml"
            token="@install.root.dir" value="${tomcat.installedApps.root}/${ProjectName}-${ProjectVersion}.ear/${WebProjectName}-${ProjectVersion}.war" />
        <replace file="${basedir}/target/${WebProjectName}-${ProjectVersion}/META-INF/context.xml"
            token="@vhost.name" value="${vhost.name}" />
        <replace file="${basedir}/target/${WebProjectName}-${ProjectVersion}/META-INF/context.xml"
            token="@tomcat.work.dir" value="${tomcat.work.directory}/${ProjectName}-${ProjectVersion}/${WebProjectName}-${ProjectVersion}" />
        <replace file="${basedir}/target/${WebProjectName}-${ProjectVersion}/META-INF/context.xml" token="@database.user.name" value="${dbusername}" />
        <replace file="${basedir}/target/${WebProjectName}-${ProjectVersion}/META-INF/context.xml" token="@database.user.password" value="${dbpassword}" />
        <replace file="${basedir}/target/${WebProjectName}-${ProjectVersion}/META-INF/context.xml" token="@mail.user.name" value="${mailusername}" />
        <replace file="${basedir}/target/${WebProjectName}-${ProjectVersion}/META-INF/context.xml" token="@mail.user.password" value="${mailpassword}" />

        <chmod file="${basedir}/target/${WebProjectName}-${ProjectVersion}/META-INF/context.xml" perm="640" />
    </target>

    <target name="buildWebLogic" if="isWebLogic">
        <copy file="${weblogic}/weblogic.xml" tofile="${basedir}/target/${WebProjectName}-${ProjectVersion}/WEB-INF/weblogic.xml" />
    </target>

    <target name="buildWebSphere" if="isWebSphere">
        <property name="websphere.install.root" value="/appvol/DASESOLUTIONS0001US/desolutions00us.ear" />

        <copy file="${websphere}/ibm-web-bnd.xmi" tofile="${basedir}/target/${WebProjectName}-${ProjectVersion}/WEB-INF/ibm-web-bnd.xmi" />
        <copy file="${websphere}/ibm-web-ext.xmi" tofile="${basedir}/target/${WebProjectName}-${ProjectVersion}/WEB-INF/ibm-web-ext.xmi" />

        <replace file="${basedir}/target/${WebProjectName}-${ProjectVersion}/WEB-INF/ibm-web-bnd.xmi"
            token="@vhost.name" value="${vhost.name}" />
        <replace file="${basedir}/target/${WebProjectName}-${ProjectVersion}/WEB-INF/ibm-web-ext.xmi"
            token="@vhost.name" value="${vhost.name}" />
    </target>

    <target name="build" depends="buildTomcat, buildWebSphere, buildWebLogic">
        <tstamp>
            <format property="TODAY" pattern="yyyy-MM-dd HH:mm:ss" />
        </tstamp>

        <touch file="${buildArea}/${ProjectName}-${ProjectVersion}.version" />

        <echo message="${ProjectName} version ${major.num}.${minor.num}.${build.num}.${rev.num} built ${TODAY}" output="${buildArea}/${ProjectName}-${ProjectVersion}.version" append="true" />
    </target>
</project>
